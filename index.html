<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>MPIK Dynamic Webpage Editor — Enhanced</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --color-primary: #0ea5a4;
            --color-accent: #f59e0b;
            --color-bg: #f6f8fb;
            --color-surface: #ffffff;
            --color-text: #0f172a;
            --radius: 12px;
            --shadow: 0 8px 24px rgba(15, 23, 42, .08);
            --shadow-soft: 0 4px 14px rgba(15, 23, 42, .06);
            --focus: 0 0 0 3px rgba(14, 165, 164, .25);
            --gap: 12px;
            --gap-lg: 16px;
            --gap-xl: 24px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            color: var(--color-text);
            background: linear-gradient(180deg, #f8fafc 0%, var(--color-bg) 100%);
        }

        header {
            position: fixed;
            inset-inline: 0;
            top: 0;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: var(--color-surface);
            box-shadow: var(--shadow);
            z-index: 30;
        }

        header h1 {
            font-size: 18px;
            margin: 0;
            font-weight: 700;
            letter-spacing: .2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-dot {
            width: 10px;
            height: 10px;
            background: var(--color-primary);
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(14, 165, 164, .15);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        main {
            padding-top: 72px;
            height: calc(100% - 72px);
            display: grid;
            grid-template-columns: 32% 68%;
            gap: var(--gap-lg);
            padding-inline: var(--gap-lg);
            padding-bottom: var(--gap-lg);
        }

        aside.toolbar {
            background: var(--color-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: var(--gap-lg);
            overflow: auto;
            max-height: calc(100vh - 96px);
        }

        section.workspace {
            background: var(--color-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 400px;
        }

        .workspace-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            background: #fcfcfd;
        }

        .workspace-body {
            position: relative;
            flex: 1;
            overflow: auto;
            background: repeating-linear-gradient(45deg, #f6f8fb, #f6f8fb 10px, #f1f5f9 10px, #f1f5f9 20px);
            padding: 16px;
        }

        .canvas-wrapper {
            position: relative;
            margin: 0 auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: var(--shadow-soft);
            border: 1px solid #e5e7eb;
            /* overflow: hidden; */
            overflow: auto; /* for scrolling */
            touch-action: none;
        }

        .section {
            position: absolute;
            border: 1px dashed rgba(15, 23, 42, .15);
            border-radius: 10px;
            overflow: visible;
            transition: box-shadow 120ms ease, border-color 120ms ease;
        }

        .section.selected {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(14, 165, 164, .25) inset;
        }

        .section-toolbar {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            background: rgba(255, 255, 255, .9);
            backdrop-filter: blur(6px);
            padding: 6px;
            border-radius: 10px;
            box-shadow: var(--shadow-soft);
            z-index: 5;
        }

        .handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--color-primary);
            border-radius: 50%;
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
            box-shadow: 0 2px 6px rgba(14, 165, 164, .4);
            border: 2px solid #fff;
            z-index: 10;
        }

        .handle-top-left {
    position: absolute;
    width: 12px;
    height: 12px;
    background: var(--color-primary);
    border-radius: 50%;
    top: -6px;
    left: -6px;
    cursor: nwse-resize;
    box-shadow: 0 2px 6px rgba(14, 165, 164, .4);
    border: 2px solid #fff;
    z-index: 10;
}


        .droppable {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .el {
            position: absolute;
            min-width: 56px;
            min-height: 32px;
            border-radius: 10px;
            box-shadow: var(--shadow-soft);
            border: 1px solid #e5e7eb;
            background: #fff;
            padding: 10px;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: transform 100ms ease;
        }

        .el:hover {
            transform: scale(1.01);
        }

        .el.selected {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        .el[data-type="heading"] {
            font-weight: 700;
            font-size: 20px;
        }

        .el[data-type="text"] {
            font-size: 14px;
            line-height: 1.5;
        }

        .el[data-type="button"] {
            border: none;
            background: var(--color-primary);
            color: #fff;
            text-align: center;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: grab;
            font-weight: 600;
        }

        .el[data-type="links"] {
            font-size: 14px;
        }

        .el[data-type="image"] {
            padding: 0;
            overflow: hidden;
            background: #f8fafc;
        }

        .el-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            background: #fff;
        }

        .e-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--color-accent);
            border: 2px solid #fff;
            border-radius: 50%;
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
            box-shadow: 0 2px 6px rgba(245, 158, 11, .4);
        }

        .controls {
            display: grid;
            gap: 10px;
        }

        .control-group {
            display: grid;
            gap: 6px;
        }

        .control-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        label {
            font-size: 12px;
            color: #475569;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="color"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: #fff;
            outline: none;
            transition: border-color 120ms ease, box-shadow 120ms ease;
            font-size: 14px;
        }

        textarea {
            min-height: 72px;
            resize: vertical;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--color-primary);
            box-shadow: var(--focus);
        }

        .btn {
            appearance: none;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            background: var(--color-primary);
            color: #fff;
            box-shadow: var(--shadow-soft);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 100ms ease, box-shadow 120ms ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(14, 165, 164, .25);
        }

        .btn.secondary {
            background: #e2e8f0;
            color: #0f172a;
        }

        .btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, .1);
        }

        .btn.ghost {
            background: transparent;
            color: var(--color-text);
            border: 1px solid #e5e7eb;
        }

        .btn.warn {
            background: #ef4444;
        }

        .btn:focus-visible {
            box-shadow: var(--focus);
            outline: none;
        }

        details {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #fff;
            box-shadow: var(--shadow-soft);
            margin-bottom: 12px;
        }

        summary {
            list-style: none;
            cursor: pointer;
            padding: 12px 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        .stage-body {
            padding: 0 14px 14px 14px;
            display: grid;
            gap: 12px;
        }

        .palette {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .palette-item {
            padding: 10px;
            border: 1px dashed #cbd5e1;
            border-radius: 10px;
            background: #fbfdff;
            text-align: center;
            font-size: 12px;
            color: #334155;
            cursor: grab;
            user-select: none;
            transition: all 120ms ease;
        }

        .palette-item:hover {
            background: #f1f5f9;
            border-color: var(--color-primary);
        }

        .palette-item:active {
            cursor: grabbing;
        }

        .preview-banner {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #fff8eb;
            color: #92400e;
            border-bottom: 1px solid #fde68a;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .icon-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #fff;
            display: grid;
            place-items: center;
            cursor: pointer;
        }

        .icon-btn:hover {
            background: #f8fafc;
        }

        .muted {
            color: #64748b;
            font-size: 12px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .right {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .sr-only {
            position: absolute;
            left: -10000px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        .is-preview .el {
            pointer-events: none !important;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--color-primary);
            color: white;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }
        #canvas {
            transition: transform 0.25s ease; /* Smooth transition for scaling */
        }

    </style>
</head>

<body>
    <header>
        <h1><span class="brand-dot" aria-hidden="true"></span> MPIK Dynamic Webpage Editor</h1>
        <div class="header-actions">
            <button class="btn" id="btn-final-preview" title="Toggle Final Preview">Final Preview</button>
        </div>
    </header>

    <main>
        <aside class="toolbar" aria-label="Editor toolbar">
            <details open id="stage1">
                <summary>Stage 1 · Webpage Dimensions & Sections</summary>
                <div class="stage-body">
                    <div class="controls">
                        <div class="control-group">
                            <label>Preset Resolutions</label>
                            <select id="preset-select" aria-label="Preset dimensions">
                                <optgroup label="Desktop Resolutions">
                                    <option value="1920x1080">Full HD (1920 × 1080)</option>
                                    <option value="1366x768" selected>HD Ready (1366 × 768)</option>
                                    <option value="1440x900">WXGA+ (1440 × 900)</option>
                                    <option value="1536x864">HD+ (1536 × 864)</option>
                                </optgroup>
                                <optgroup label="Mobile & Tablet">
                                    <option value="1024x768">iPad (1024 × 768)</option>
                                    <option value="768x1024">iPad Portrait (768 × 1024)</option>
                                    <option value="375x667">iPhone (375 × 667)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="grid-2">
                            <div class="control-group">
                                <label for="page-width">Custom Width (px)</label>
                                <input id="page-width" type="number" min="320" value="1366" />
                            </div>
                            <div class="control-group">
                                <label for="page-height">Custom Height (px)</label>
                                <input id="page-height" type="number" min="400" value="768" />
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="section-count">Number of Sections</label>
                            <input id="section-count" type="number" min="1" max="20" value="3" />
                        </div>
                        <div class="right">
                            <button class="btn" id="btn-generate">Generate Layout</button>
                        </div>
                    </div>

                    <div class="controls" id="sections-config" hidden>
                        <div class="control-group">
                            <label>Section Configuration<span class="badge">NEW</span></label>
                            <div id="sections-list" class="controls"></div>
                        </div>
                        <div class="right">
                            <button class="btn ghost" id="btn-s1-save">Save</button>
                            <button class="btn" id="btn-s1-next">Next: Customize Sections</button>
                        </div>
                    </div>
                </div>
            </details>

            <details id="stage2">
                <summary>Stage 2 · Section & Element Customization</summary>
                <div class="stage-body">
                    <p class="muted">Select a section on the canvas to customize it.</p>

                    <div class="controls">
                        <div class="control-group">
                            <label>Section Layout <span class="badge">NEW</span></label>
                            <select id="sec-layout-type">
                                <option value="horizontal">Horizontal (Full Width)</option>
                                <option value="vertical-left">Vertical Column (Left)</option>
                                <option value="vertical-right">Vertical Column (Right)</option>
                            </select>
                        </div>

                        <div class="grid-3">
                            <div class="control-group">
                                <label>Section Width (px)</label>
                                <input id="sec-width" type="number" min="100" />
                            </div>
                            <div class="control-group">
                                <label>Section Height (px)</label>
                                <input id="sec-height" type="number" min="60" />
                            </div>
                            <div class="control-group">
                                <label>Section Background</label>
                                <input id="sec-bg" type="color" value="#ffffff" />
                            </div>
                        </div>

                        <div class="control-group">
                            <label>Add Elements</label>
                            <div class="palette" aria-label="Palette of elements to drag into section">
                                <div class="palette-item" draggable="true" data-kind="heading">Heading</div>
                                <div class="palette-item" draggable="true" data-kind="text">Text</div>
                                <div class="palette-item" draggable="true" data-kind="button">Button</div>
                                <div class="palette-item" draggable="true" data-kind="links">Quick Links</div>
                                <div class="palette-item" draggable="true" data-kind="image">Image</div>
                                <div class="palette-item" draggable="true" data-kind="icon">Icon/Logo</div>
                            </div>
                            <div class="control-row">
                                <label for="upload-image" class="sr-only">Upload Image</label>
                                <input id="upload-image" type="file" accept="image/*" />
                                <button class="btn secondary" id="btn-insert-upload">Insert Uploaded as Image</button>
                            </div>
                        </div>

                        <div class="grid-3">
                            <div class="control-group">
                                <label>Element Background</label>
                                <input id="el-bg" type="color" value="#ffffff" />
                            </div>
                            <div class="control-group">
                                <label>Element Text Color</label>
                                <input id="el-color" type="color" value="#0f172a" />
                            </div>
                            <div class="control-group">
                                <label>Selected Element Size (px)</label>
                                <div class="grid-2">
                                    <input id="el-w" type="number" min="56" placeholder="Width" />
                                    <input id="el-h" type="number" min="32" placeholder="Height" />
                                </div>
                            </div>
                        </div>

                        <div class="right">
                            <button class="btn ghost" id="btn-s2-save">Save</button>
                            <button class="btn" id="btn-s2-next">Next: Edit Content</button>
                        </div>
                    </div>
                </div>
            </details>

            <details id="stage3">
                <summary>Stage 3 · Content Editing</summary>
                <div class="stage-body">
                    <p class="muted">Select a text/heading/button/links element on the canvas to edit.</p>

                    <div role="toolbar" aria-label="Text formatting" class="control-row">
                        <button class="btn secondary" id="fmt-bold"><strong>B</strong></button>
                        <button class="btn secondary" id="fmt-italic"><em>I</em></button>
                        <div class="control-group" style="min-width:120px;">
                            <label for="fmt-size">Font Size (px)</label>
                            <input id="fmt-size" type="number" min="10" max="72" value="16" />
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="el-label">Text / Label</label>
                        <input id="el-label" type="text" placeholder="Edit selected element text..." />
                    </div>

                    <div class="control-group">
                        <label for="links-items">Quick Links (comma-separated)</label>
                        <input id="links-items" type="text" placeholder="e.g., Home, About, Contact" />
                        <p class="muted">Orientation auto-adjusts based on the element's width and height.</p>
                    </div>

                    <div class="right">
                        <button class="btn ghost" id="btn-s3-save">Save</button>
                        <button class="btn" id="btn-s3-preview">Preview Mode</button>
                    </div>
                </div>
            </details>
        </aside>

        <section class="workspace" aria-label="Editing workspace">
            <div class="workspace-header">
                <div class="muted">Workspace · Drag to move elements, use corner handle to resize.</div>
                <div class="control-row">
                    <button class="btn ghost" id="btn-fit">Actual Size</button>
                    <button class="btn" id="btn-preview">Preview</button>
                </div>
            </div>
            <div class="workspace-body">
                <div id="canvas" class="canvas-wrapper" style="width:1366px; height:768px;"></div>
            </div>
        </section>
    </main>

    <template id="tpl-section-item">
        <div class="control-row" data-item>
            <span class="muted" data-title>Section</span>
            <div class="grid-2" style="flex:1;">
                <input type="number" min="100" data-w placeholder="Width" />
                <input type="number" min="60" data-h placeholder="Height" />
            </div>
            <button class="btn secondary" data-focus>Select</button>
            <button class="btn warn" data-del>Delete</button>
        </div>
    </template>

    <script type="module">
        const STORAGE_KEY = 'mpik-editor-v2';
        const el = (sel) => document.querySelector(sel);
        const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
        let uidCounter = 0;
        const uid = (prefix) => `${prefix}-${++uidCounter}-${Date.now()}`;

        const state = {
            page: { width: 1366, height: 768 },
            sections: [],
            selectedSectionId: null,
            selectedElementId: null,
            previewMode: false,
            uploadedImageDataURL: null
        };

        const presetSelect = el('#preset-select');
        const inputPageW = el('#page-width');
        const inputPageH = el('#page-height');
        const inputSectionCount = el('#section-count');
        const btnGenerate = el('#btn-generate');
        const s1Panel = el('#sections-config');
        const sectionsList = el('#sections-list');
        const btnS1Save = el('#btn-s1-save');
        const btnS1Next = el('#btn-s1-next');
        const inputSecW = el('#sec-width');
        const inputSecH = el('#sec-height');
        const inputSecBG = el('#sec-bg');
        const secLayoutType = el('#sec-layout-type');
        const inputElBG = el('#el-bg');
        const inputElColor = el('#el-color');
        const inputElW = el('#el-w');
        const inputElH = el('#el-h');
        const uploadImage = el('#upload-image');
        const btnInsertUpload = el('#btn-insert-upload');
        const btnS2Save = el('#btn-s2-save');
        const btnS2Next = el('#btn-s2-next');
        const fmtBold = el('#fmt-bold');
        const fmtItalic = el('#fmt-italic');
        const fmtSize = el('#fmt-size');
        const elLabel = el('#el-label');
        const inputLinksItems = el('#links-items');
        const btnS3Save = el('#btn-s3-save');
        const btnS3Preview = el('#btn-s3-preview');
        const btnFit = el('#btn-fit');
        const btnPreview = el('#btn-preview');
        const btnFinalPreview = el('#btn-final-preview');
        const canvas = el('#canvas');

        const Icons = {
            trash: `<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z"/></svg>`
        };

        function getSelectedSection() {
            return state.sections.find(s => s.id === state.selectedSectionId);
        }

        function getSelectedElement() {
            const sec = getSelectedSection();
            if (!sec) return null;
            return sec.elements.find(e => e.id === state.selectedElementId);
        }

        function selectSection(id) {
            state.selectedSectionId = id;
            state.selectedElementId = null;
            CanvasManager.render();
            Toolbar.refreshSectionFields();
            Toolbar.refreshElementFields();
        }

        function selectElement(secId, elId) {
            state.selectedSectionId = secId;
            state.selectedElementId = elId;
            CanvasManager.render();
            Toolbar.refreshElementFields();
        }

        function deleteSection(id) {
            state.sections = state.sections.filter(s => s.id !== id);
            if (state.selectedSectionId === id) {
                state.selectedSectionId = state.sections[0]?.id || null;
                state.selectedElementId = null;
            }
            repositionSections();
            CanvasManager.render();
            Toolbar.refreshSectionList();
            Toolbar.refreshSectionFields();
        }

        function deleteElement(id) {
            const sec = getSelectedSection();
            if (!sec) return;
            sec.elements = sec.elements.filter(e => e.id !== id);
            if (state.selectedElementId === id) {
                state.selectedElementId = null;
            }
            CanvasManager.render();
            Toolbar.refreshElementFields();
        }

        function findElementNode(elId) {
            return el(`.el[data-id="${elId}"]`);
        }

        function repositionSections() {
            if (state.sections.length === 0) return;

            let currentY = 0;
            const gap = 12;
            const columns = { left: [], right: [], full: [] };

            state.sections.forEach(sec => {
                const layout = sec.layoutType || 'horizontal';
                if (layout === 'vertical-left') {
                    columns.left.push(sec);
                } else if (layout === 'vertical-right') {
                    columns.right.push(sec);
                } else {
                    columns.full.push(sec);
                }
            });

            const pageWidth = state.page.width;
            const pageHeight = state.page.height;
            let leftY = 0, rightY = 0, fullY = 0;

            const processColumn = (sections, x, maxWidth) => {
                let y = 0;
                sections.forEach(sec => {
                    sec.x = x;
                    sec.y = y;
                    sec.width = Math.min(sec.width, maxWidth);
                    y += sec.height + gap;
                });
                return y;
            };

            const columnWidth = Math.floor(pageWidth / 2) - gap;

            if (columns.left.length > 0) {
                leftY = processColumn(columns.left, 0, columnWidth);
            }
            if (columns.right.length > 0) {
                rightY = processColumn(columns.right, columnWidth + gap, columnWidth);
            }

            const verticalMaxY = Math.max(leftY, rightY);

            columns.full.forEach(sec => {
                sec.x = 0;
                sec.y = verticalMaxY > 0 ? verticalMaxY : fullY;
                sec.width = Math.min(sec.width, pageWidth);
                fullY = sec.y + sec.height + gap;
            });

            const totalHeight = Math.max(verticalMaxY, fullY);
            if (totalHeight > pageHeight + 100) {
                console.warn('Sections exceed page height. Consider adjusting section heights.');
            }

            state.sections.forEach(sec => {
                if (sec.y + sec.height > pageHeight) {
                    sec.height = Math.max(100, pageHeight - sec.y - gap);
                }
            });
        }

        const CanvasManager = {
            scale: 1,
            isFitted: false, // for toggling fit to view
            offsetX: 0,
            offsetY: 0,

            clearTransform() {
                this.scale = 1;
                this.offsetX = 0;
                this.offsetY = 0;
            },

            // fitToView() {
            //     if (!canvas) return;
            //     const parent = canvas.parentElement;
            //     const pw = parent.clientWidth - 32;
            //     const ph = parent.clientHeight - 32;
            //     const cw = state.page.width;
            //     const ch = state.page.height;
            //     const scaleX = pw / cw;
            //     const scaleY = ph / ch;
            //     this.scale = Math.min(scaleX, scaleY, 1);
            //     canvas.style.transform = `scale(${this.scale})`;
            //     canvas.style.transformOrigin = 'top left';
            // },
            
            fitToView() {
                if (!canvas) return;

                // If already fitted, restore to actual size
                if (this.isFitted) {
                    this.scale = 1;
                    canvas.style.transform = 'scale(1)';
                    canvas.style.transformOrigin = 'top left';
                    this.isFitted = false;
                    const btn = document.querySelector('#btn-fit');
                    if (btn) btn.textContent = 'Fit to View';
                    return;
                }

                // Otherwise, fit the canvas to workspace view
                const parent = canvas.parentElement;
                const pw = parent.clientWidth - 32;
                const ph = parent.clientHeight - 32;
                const cw = state.page.width;
                const ch = state.page.height;
                const scaleX = pw / cw;
                const scaleY = ph / ch;

                this.scale = Math.min(scaleX, scaleY, 1);
                canvas.style.transform = `scale(${this.scale})`;
                canvas.style.transformOrigin = 'top left';
                this.isFitted = true;

                const btn = document.querySelector('#btn-fit');
                if (btn) btn.textContent = 'Actual Size';
            },


            render() {
                if (!canvas) return;
                canvas.style.width = state.page.width + 'px';
                canvas.style.height = state.page.height + 'px';
                canvas.innerHTML = '';

                state.sections.forEach(sec => {
                    const secDiv = document.createElement('div');
                    secDiv.className = 'section';
                    if (sec.id === state.selectedSectionId) secDiv.classList.add('selected');
                    secDiv.dataset.id = sec.id;
                    secDiv.style.cssText = `
                        left: ${sec.x}px;
                        top: ${sec.y}px;
                        width: ${sec.width}px;
                        height: ${sec.height}px;
                        background: ${sec.bg || '#ffffff'};
                    `;

                    if (!state.previewMode) {
                        const toolbar = document.createElement('div');
                        toolbar.className = 'section-toolbar';
                        toolbar.innerHTML = `<button class="icon-btn" data-delete>${Icons.trash}</button>`;
                        toolbar.querySelector('[data-delete]').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteSection(sec.id);
                        });
                        secDiv.appendChild(toolbar);

                        const handle = document.createElement('div');
                        handle.className = 'handle';
                        handle.addEventListener('mousedown', (e) => ResizeSection.start(e, sec.id));
                        secDiv.appendChild(handle);
                        
                        const handleTL = document.createElement('div');
                        handleTL.className = 'handle-top-left';
                        handleTL.addEventListener('mousedown', (e) => ResizeSection.start(e, sec.id, true));
                        secDiv.appendChild(handleTL);

                    }

                    const drop = document.createElement('div');
                    drop.className = 'droppable';
                    drop.dataset.sectionId = sec.id;
                    drop.addEventListener('dragover', DnD.onDragOver);
                    drop.addEventListener('drop', DnD.onDrop);

                    sec.elements.forEach(elem => {
                        const elemDiv = document.createElement('div');
                        elemDiv.className = 'el';
                        elemDiv.dataset.id = elem.id;
                        elemDiv.dataset.type = elem.type;
                        if (elem.id === state.selectedElementId) elemDiv.classList.add('selected');

                        const w = elem.w || 160;
                        const h = elem.h || 40;
                        elemDiv.style.cssText = `
                            left: ${elem.x || 0}px;
                            top: ${elem.y || 0}px;
                            width: ${w}px;
                            height: ${h}px;
                            background: ${elem.style?.background || '#fff'};
                            color: ${elem.style?.color || '#0f172a'};
                            font-size: ${elem.style?.fontSize || 16}px;
                            font-weight: ${elem.style?.fontWeight || 'normal'};
                            font-style: ${elem.style?.fontStyle || 'normal'};
                        `;

                        if (elem.type === 'image' || elem.type === 'icon') {
                            const img = document.createElement('img');
                            img.className = 'el-img';
                            img.src = elem.src || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect fill="%23f1f5f9" width="100" height="100"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%2394a3b8"%3EImage%3C/text%3E%3C/svg%3E';
                            elemDiv.appendChild(img);
                        } else if (elem.type === 'links') {
                            const items = elem.items || ['Home', 'About', 'Contact'];
                            const isHorizontal = w > h;
                            elemDiv.style.flexDirection = isHorizontal ? 'row' : 'column';
                            elemDiv.style.gap = '8px';
                            elemDiv.innerHTML = items.map(i => `<a href="#" style="color:inherit;text-decoration:none;">${i}</a>`).join('');
                        } else {
                            elemDiv.textContent = elem.content || 'Content';
                        }

                        if (!state.previewMode) {
                            elemDiv.addEventListener('mousedown', (e) => {
                                if (e.target.classList.contains('e-handle')) return;
                                selectElement(sec.id, elem.id);
                                Drag.start(e, elem.id);
                            });

                            const eHandle = document.createElement('div');
                            eHandle.className = 'e-handle';
                            eHandle.addEventListener('mousedown', (e) => {
                                e.stopPropagation();
                                ResizeEl.start(e, sec.id, elem.id);
                            });
                            elemDiv.appendChild(eHandle);
                        }

                        drop.appendChild(elemDiv);
                    });

                    if (!state.previewMode) {
                        secDiv.addEventListener('click', (e) => {
                            if (e.target === secDiv || e.target.classList.contains('droppable')) {
                                selectSection(sec.id);
                            }
                        });
                    }

                    secDiv.appendChild(drop);
                    canvas.appendChild(secDiv);
                });
            }
        };

        const Toolbar = {
            refreshSectionList() {
                if (!sectionsList) return;
                sectionsList.innerHTML = '';
                const tpl = el('#tpl-section-item');
                state.sections.forEach((s, idx) => {
                    const item = tpl.content.cloneNode(true).querySelector('[data-item]');
                    item.querySelector('[data-title]').textContent = `Section ${idx + 1}`;
                    const iw = item.querySelector('[data-w]');
                    const ih = item.querySelector('[data-h]');
                    iw.value = s.width;
                    ih.value = s.height;

                    iw.addEventListener('change', () => {
                        s.width = clamp(parseInt(iw.value || 0, 10), 100, state.page.width);
                        repositionSections();
                        CanvasManager.render();
                    });
                    ih.addEventListener('change', () => {
                        s.height = clamp(parseInt(ih.value || 0, 10), 60, state.page.height);
                        repositionSections();
                        CanvasManager.render();
                    });
                    item.querySelector('[data-focus]').addEventListener('click', () => {
                        selectSection(s.id);
                        el(`.section[data-id="${s.id}"]`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                    item.querySelector('[data-del]').addEventListener('click', () => deleteSection(s.id));
                    sectionsList.appendChild(item);
                });
                if (s1Panel) s1Panel.hidden = state.sections.length === 0;
            },

            refreshSectionFields() {
                if (!inputSecW || !inputSecH || !inputSecBG) return;
                const s = getSelectedSection();
                if (!s) {
                    inputSecW.value = '';
                    inputSecH.value = '';
                    inputSecBG.value = '#ffffff';
                    if (secLayoutType) secLayoutType.value = 'horizontal';
                    return;
                }
                inputSecW.value = s.width;
                inputSecH.value = s.height;
                inputSecBG.value = s.bg || '#ffffff';
                if (secLayoutType) secLayoutType.value = s.layoutType || 'horizontal';
            },

            refreshElementFields() {
                if (!elLabel || !fmtSize || !inputElBG || !inputElColor || !inputElW || !inputElH || !inputLinksItems) return;
                const e = getSelectedElement();
                if (!e) {
                    elLabel.value = '';
                    fmtSize.value = 16;
                    inputElBG.value = '#ffffff';
                    inputElColor.value = '#0f172a';
                    inputElW.value = '';
                    inputElH.value = '';
                    inputLinksItems.value = '';
                    return;
                }
                if (['button', 'text', 'heading', 'links'].includes(e.type)) {
                    elLabel.value = e.content || '';
                    fmtSize.value = e.style?.fontSize || (e.type === 'heading' ? 20 : 16);
                } else {
                    elLabel.value = '';
                }
                inputElBG.value = e.style?.background || '#ffffff';
                inputElColor.value = e.style?.color || '#0f172a';
                inputElW.value = e.w || '';
                inputElH.value = e.h || '';
                if (e.type === 'links') {
                    inputLinksItems.value = (Array.isArray(e.items) ? e.items : ['Home', 'About', 'Contact']).join(', ');
                } else {
                    inputLinksItems.value = '';
                }
            }
        };

        const Drag = {
            dragging: null,
            start(ev, elId) {
                const sec = getSelectedSection();
                if (!sec) return;
                const e = sec.elements.find(x => x.id === elId);
                if (!e) return;
                const node = findElementNode(elId);
                if (!node) return;
                const rect = node.getBoundingClientRect();
                this.dragging = {
                    elId,
                    offsetX: ev.clientX - rect.left,
                    offsetY: ev.clientY - rect.top
                };
                document.addEventListener('mousemove', this.move);
                document.addEventListener('mouseup', this.stop);
            },
            move: (ev) => {
                const sec = getSelectedSection();
                if (!sec || !Drag.dragging) return;
                const drop = el(`.section[data-id="${sec.id}"] .droppable`);
                if (!drop) return;
                const rect = drop.getBoundingClientRect();
                const e = sec.elements.find(x => x.id === Drag.dragging.elId);
                if (!e) return;
                
                const scale = CanvasManager.scale || 1;
                const localX = (ev.clientX - rect.left) / scale;
                const localY = (ev.clientY - rect.top) / scale;
                
                const maxX = sec.width - (e.w || 160);
                const maxY = sec.height - (e.h || 40);
                e.x = clamp(localX - Drag.dragging.offsetX / scale, 0, maxX);
                e.y = clamp(localY - Drag.dragging.offsetY / scale, 0, maxY);
                CanvasManager.render();
            },
            stop() {
                document.removeEventListener('mousemove', Drag.move);
                document.removeEventListener('mouseup', Drag.stop);
                Drag.dragging = null;
            }
        };

        const ResizeSection = {
            active: null,
            start(ev, secId, isTopLeft = false) {
                ev.preventDefault();
                const s = state.sections.find(x => x.id === secId);
                if (!s) return;
                this.active = {
                    secId,
                    startW: s.width,
                    startH: s.height,
                    startX: ev.clientX,
                    startY: ev.clientY,
                    startLeft: s.x,
                    startTop: s.y,
                    isTopLeft
                };
                document.addEventListener('mousemove', this.move);
                document.addEventListener('mouseup', this.stop);
            },
            move(ev) {
                const a = ResizeSection.active;
                if (!a) return;
                const s = state.sections.find(x => x.id === a.secId);
                if (!s) return;
                const scale = CanvasManager.scale || 1;
                const dx = (ev.clientX - a.startX) / scale;
                const dy = (ev.clientY - a.startY) / scale;

                if (a.isTopLeft) {
                    const newW = clamp(a.startW - dx, 100, state.page.width);
                    const newH = clamp(a.startH - dy, 60, state.page.height);
                    const deltaW = newW - s.width;
                    const deltaH = newH - s.height;
                    s.x = clamp(a.startLeft + dx, 0, state.page.width - newW);
                    s.y = clamp(a.startTop + dy, 0, state.page.height - newH);
                    s.width = newW;
                    s.height = newH;
                } else {
                    s.width = clamp(a.startW + dx, 100, state.page.width - s.x);
                    s.height = clamp(a.startH + dy, 60, state.page.height - s.y);
                }

                CanvasManager.render();
                Toolbar.refreshSectionFields();
                Toolbar.refreshSectionList();
            },
            stop() {
                document.removeEventListener('mousemove', ResizeSection.move);
                document.removeEventListener('mouseup', ResizeSection.stop);
                ResizeSection.active = null;
            }
        };

        const ResizeEl = {
            active: null,
            start(ev, secId, elId) {
                ev.preventDefault();
                const s = state.sections.find(x => x.id === secId);
                if (!s) return;
                const e = s.elements.find(x => x.id === elId);
                if (!e) return;
                this.active = {
                    secId,
                    elId,
                    startW: e.w || 160,
                    startH: e.h || 40,
                    startX: ev.clientX,
                    startY: ev.clientY
                };
                document.addEventListener('mousemove', this.move);
                document.addEventListener('mouseup', this.stop);
            },
            move: (ev) => {
                const a = ResizeEl.active;
                if (!a) return;
                const s = state.sections.find(x => x.id === a.secId);
                if (!s) return;
                const e = s.elements.find(x => x.id === a.elId);
                if (!e) return;
                const scale = CanvasManager.scale || 1;
                const dx = (ev.clientX - a.startX) / scale;
                const dy = (ev.clientY - a.startY) / scale;
                const minW = 56, minH = 32;
                const maxW = (s.width - (e.x || 0));
                const maxH = (s.height - (e.y || 0));
                e.w = clamp((a.startW + dx), minW, maxW);
                e.h = clamp((a.startH + dy), minH, maxH);
                CanvasManager.render();
                Toolbar.refreshElementFields();
            },
            stop() {
                document.removeEventListener('mousemove', ResizeEl.move);
                document.removeEventListener('mouseup', ResizeEl.stop);
                ResizeEl.active = null;
            }
        };

        const DnD = {
            onDragOver(ev) {
                ev.preventDefault();
                ev.dataTransfer.dropEffect = 'copy';
            },
            onDrop(ev) {
                ev.preventDefault();
                const kind = ev.dataTransfer.getData('text/plain');
                const secId = ev.currentTarget.dataset.sectionId;
                if (!secId || !kind) return;
                const rect = ev.currentTarget.getBoundingClientRect();
                const scale = CanvasManager.scale || 1;
                const x = (ev.clientX - rect.left) / scale;
                const y = (ev.clientY - rect.top) / scale;
                addElement(secId, kind, { x, y });
            }
        };

        const Serialize = {
            toJSON() {
                return JSON.stringify(state, null, 2);
            },
            fromJSON(json) {
                const data = JSON.parse(json);
                if (!data.page || !Array.isArray(data.sections)) throw new Error('Invalid JSON');
                Object.assign(state, {
                    page: data.page,
                    sections: data.sections,
                    selectedSectionId: null,
                    selectedElementId: null,
                    previewMode: false,
                });
                CanvasManager.render();
                Toolbar.refreshSectionList();
                Toolbar.refreshSectionFields();
                Toolbar.refreshElementFields();
            },
        };

        function saveLocal() {
            try {
                localStorage.setItem(STORAGE_KEY, Serialize.toJSON());
                alert('Saved successfully!');
            } catch (e) {
                console.warn('Save failed', e);
            }
        }

        function tryLoadLocal() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                try {
                    Serialize.fromJSON(raw);
                    return true;
                } catch (e) {
                    console.warn('Load failed', e);
                }
            }
            return false;
        }

        function generateLayout() {
            const preset = presetSelect?.value || '1366x768';
            const [pw, ph] = preset.split('x').map(n => parseInt(n, 10));
            const customW = parseInt(inputPageW?.value || 0, 10) || 0;
            const customH = parseInt(inputPageH?.value || 0, 10) || 0;
            state.page.width = clamp(customW || pw, 320, 4000);
            state.page.height = clamp(customH || ph, 400, 4000);
            CanvasManager.clearTransform();

            const count = clamp(parseInt(inputSectionCount?.value || 1, 10), 1, 20);
            state.sections = [];
            const baseH = Math.floor((state.page.height - (count - 1) * 12) / count);
            for (let i = 0; i < count; i++) {
                state.sections.push({
                    id: uid('sec'),
                    x: 0,
                    y: 0,
                    width: state.page.width,
                    height: clamp(baseH, 100, 2000),
                    bg: '#ffffff',
                    layoutType: 'horizontal',
                    elements: []
                });
            }
            repositionSections();
            state.selectedSectionId = state.sections[0]?.id || null;
            state.selectedElementId = null;

            CanvasManager.render();
            Toolbar.refreshSectionList();
            Toolbar.refreshSectionFields();
            if (s1Panel) s1Panel.hidden = false;
        }

        function addElement(secId, kind, pos) {
            const s = state.sections.find(x => x.id === secId);
            if (!s) return;
            const px = Math.round(pos.x || 40);
            const py = Math.round(pos.y || 20);
            const e = {
                id: uid('el'),
                type: kind,
                x: clamp(px - 40, 0, s.width - 80),
                y: clamp(py - 20, 0, s.height - 40),
                w: 200,
                h: (kind === 'image' || kind === 'icon') ? 120 : 48,
                content: null,
                style: {}
            };
            if (kind === 'heading') {
                e.content = 'Your Heading';
                e.style.fontSize = 20;
                e.style.fontWeight = '700';
            }
            if (kind === 'text') {
                e.content = 'Your text...';
                e.style.fontSize = 16;
            }
            if (kind === 'button') {
                e.content = 'Button';
                e.style.fontSize = 16;
            }
            if (kind === 'links') {
                e.content = 'Quick Links';
                e.w = 220;
                e.h = 90;
                e.items = ['Home', 'About', 'Contact'];
            }
            if ((kind === 'image' || kind === 'icon') && state.uploadedImageDataURL) {
                e.src = state.uploadedImageDataURL;
            }

            s.elements.push(e);
            state.selectedSectionId = secId;
            state.selectedElementId = e.id;
            CanvasManager.render();
            Toolbar.refreshElementFields();
        }

        if (presetSelect) presetSelect.addEventListener('change', () => {
            const [w, h] = presetSelect.value.split('x').map(n => parseInt(n, 10));
            if (inputPageW) inputPageW.value = w;
            if (inputPageH) inputPageH.value = h;
        });
        if (btnGenerate) btnGenerate.addEventListener('click', generateLayout);
        if (btnS1Save) btnS1Save.addEventListener('click', saveLocal);
        if (btnS1Next) btnS1Next.addEventListener('click', () => {
            el('#stage1')?.removeAttribute('open');
            el('#stage2')?.setAttribute('open', '');
        });

        if (secLayoutType) secLayoutType.addEventListener('change', () => {
            const s = getSelectedSection();
            if (!s) return;
            s.layoutType = secLayoutType.value;
            repositionSections();
            CanvasManager.render();
        });

        if (inputSecW) inputSecW.addEventListener('change', () => {
            const s = getSelectedSection();
            if (!s) return;
            s.width = clamp(parseInt(inputSecW.value || 0, 10), 100, state.page.width);
            repositionSections();
            CanvasManager.render();
            Toolbar.refreshSectionList();
        });
        if (inputSecH) inputSecH.addEventListener('change', () => {
            const s = getSelectedSection();
            if (!s) return;
            s.height = clamp(parseInt(inputSecH.value || 0, 10), 60, state.page.height);
            repositionSections();
            CanvasManager.render();
            Toolbar.refreshSectionList();
        });
        if (inputSecBG) inputSecBG.addEventListener('input', () => {
            const s = getSelectedSection();
            if (!s) return;
            s.bg = inputSecBG.value;
            CanvasManager.render();
        });

        const paletteItems = Array.from(document.querySelectorAll('.palette-item') || []);
        paletteItems.forEach(p => {
            p.addEventListener('dragstart', (ev) => {
                const kind = ev.target.dataset.kind;
                if (!kind) return;
                ev.dataTransfer.setData('text/plain', kind);
                ev.dataTransfer.effectAllowed = 'copy';
            });
        });

        if (uploadImage) uploadImage.addEventListener('change', () => {
            const file = uploadImage.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                state.uploadedImageDataURL = reader.result;
            };
            reader.readAsDataURL(file);
        });
        if (btnInsertUpload) btnInsertUpload.addEventListener('click', () => {
            const s = getSelectedSection();
            if (!s || !state.uploadedImageDataURL) return;
            addElement(s.id, 'image', { x: 40, y: 40 });
        });

        if (inputElBG) inputElBG.addEventListener('input', () => {
            const e = getSelectedElement();
            if (!e) return;
            e.style = e.style || {};
            e.style.background = inputElBG.value;
            CanvasManager.render();
        });
        if (inputElColor) inputElColor.addEventListener('input', () => {
            const e = getSelectedElement();
            if (!e) return;
            e.style = e.style || {};
            e.style.color = inputElColor.value;
            CanvasManager.render();
        });
        if (inputElW) inputElW.addEventListener('change', () => {
            const s = getSelectedSection();
            const e = getSelectedElement();
            if (!s || !e) return;
            e.w = clamp(parseInt(inputElW.value || 0, 10), 56, s.width - (e.x || 0));
            CanvasManager.render();
        });
        if (inputElH) inputElH.addEventListener('change', () => {
            const s = getSelectedSection();
            const e = getSelectedElement();
            if (!s || !e) return;
            e.h = clamp(parseInt(inputElH.value || 0, 10), 32, s.height - (e.y || 0));
            CanvasManager.render();
        });

        if (btnS2Save) btnS2Save.addEventListener('click', saveLocal);
        if (btnS2Next) btnS2Next.addEventListener('click', () => {
            el('#stage2')?.removeAttribute('open');
            el('#stage3')?.setAttribute('open', '');
        });

        if (fmtBold) fmtBold.addEventListener('click', () => {
            const e = getSelectedElement();
            if (!e) return;
            e.style = e.style || {};
            e.style.fontWeight = (e.style.fontWeight === '700' || e.style.fontWeight === 'bold') ? '400' : '700';
            CanvasManager.render();
            Toolbar.refreshElementFields();
        });
        if (fmtItalic) fmtItalic.addEventListener('click', () => {
            const e = getSelectedElement();
            if (!e) return;
            e.style = e.style || {};
            e.style.fontStyle = e.style.fontStyle === 'italic' ? 'normal' : 'italic';
            CanvasManager.render();
            Toolbar.refreshElementFields();
        });
        if (fmtSize) fmtSize.addEventListener('change', () => {
            const e = getSelectedElement();
            if (!e) return;
            e.style = e.style || {};
            e.style.fontSize = clamp(parseInt(fmtSize.value || 16, 10), 10, 72);
            CanvasManager.render();
        });
        if (elLabel) elLabel.addEventListener('input', () => {
            const e = getSelectedElement();
            if (!e) return;
            if (['heading', 'text', 'button'].includes(e.type)) {
                e.content = elLabel.value;
            }
            CanvasManager.render();
        });
        if (inputLinksItems) inputLinksItems.addEventListener('input', () => {
            const e = getSelectedElement();
            if (!e || e.type !== 'links') return;
            const parts = inputLinksItems.value.split(',').map(s => s.trim()).filter(Boolean);
            e.items = parts.length ? parts : ['Home', 'About', 'Contact'];
            CanvasManager.render();
        });

        if (btnS3Save) btnS3Save.addEventListener('click', saveLocal);
        if (btnS3Preview) btnS3Preview.addEventListener('click', togglePreview);

        if (btnFit) btnFit.addEventListener('click', () => CanvasManager.fitToView());
        if (btnPreview) btnPreview.addEventListener('click', togglePreview);
        if (btnFinalPreview) btnFinalPreview.addEventListener('click', togglePreview);

        function togglePreview() {
            state.previewMode = !state.previewMode;
            const body = el('.workspace') || document.body;
            const bannerId = 'preview-banner';
            if (state.previewMode) {
                const banner = document.createElement('div');
                banner.className = 'preview-banner';
                banner.id = bannerId;
                banner.innerHTML = `<strong>Preview Mode</strong><div class="control-row"><button class="btn secondary" id="btn-exit-preview">Exit Preview</button></div>`;
                body.insertBefore(banner, body.firstChild);
                CanvasManager.render();
                el('#btn-exit-preview')?.addEventListener('click', togglePreview);
            } else {
                el('#' + bannerId)?.remove();
                CanvasManager.render();
            }
        }

        function init() {
            if (!tryLoadLocal()) {
                generateLayout();
            }
            CanvasManager.fitToView();
        }

        document.addEventListener('keydown', (ev) => {
            if (ev.key === 'Delete') {
                const e = getSelectedElement();
                if (e) deleteElement(e.id);
            }
        });

        init();
    </script>

</body>

</html>
